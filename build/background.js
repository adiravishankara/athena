console.log("Background script loaded");function u(e){chrome.tabs.get(e,r=>{const o=r.url;if(!o||o.startsWith("chrome://")||o.startsWith("chrome-extension://")||o.startsWith("edge://")||o.startsWith("about:")){console.log("Cannot inject script into",o);return}chrome.scripting.executeScript({target:{tabId:e},function:()=>{if(document.getElementById("athena-floating-button"))return;const t=document.createElement("div");t.id="athena-floating-button",t.innerHTML="+",t.style.position="fixed",t.style.bottom="20px",t.style.right="20px",t.style.background="#004d40",t.style.color="white",t.style.padding="15px 18px",t.style.borderRadius="50%",t.style.fontSize="24px",t.style.fontWeight="bold",t.style.cursor="pointer",t.style.zIndex="10000",t.style.boxShadow="0 2px 5px rgba(0,0,0,0.3)",t.style.display="flex",t.style.justifyContent="center",t.style.alignItems="center",t.style.width="40px",t.style.height="40px";let n=!1,s,c;t.addEventListener("mousedown",function(i){n=!0,s=i.clientX-t.getBoundingClientRect().left,c=i.clientY-t.getBoundingClientRect().top}),document.addEventListener("mousemove",function(i){if(n){const a=i.clientX-s,l=i.clientY-c;t.style.right="auto",t.style.bottom="auto",t.style.left=a+"px",t.style.top=l+"px"}}),document.addEventListener("mouseup",function(){n=!1}),t.addEventListener("click",function(i){if(!n){const a=window.location.href,l=document.title;chrome.runtime.sendMessage({action:"ADD_SOURCE",url:a,title:l,type:"web",datetime:new Date().toISOString()});const d=t.style.background;t.style.background="#2e7d32",t.innerHTML="âœ“",setTimeout(()=>{t.style.background=d,t.innerHTML="+"},1e3)}}),document.body.appendChild(t)}}).catch(t=>{console.error("Script injection error:",t)})})}function g(e){chrome.scripting.executeScript({target:{tabId:e},function:()=>{const r=document.getElementById("athena-floating-button");r&&r.remove()}}).catch(r=>{console.log("Cannot remove button from this page")})}chrome.runtime.onInstalled.addListener(()=>{console.log("Athena Extension Installed"),chrome.storage.local.get(["notebooks","currentNotebook","researchMode"],e=>{e.notebooks||chrome.storage.local.set({notebooks:{}}),e.currentNotebook||chrome.storage.local.set({currentNotebook:null}),e.researchMode===void 0&&chrome.storage.local.set({researchMode:!1})})});chrome.tabs.onUpdated.addListener((e,r,o)=>{r.status==="complete"&&chrome.storage.local.get(["researchMode"],t=>{(t.researchMode||!1)&&u(e)})});chrome.tabs.onCreated.addListener(e=>{chrome.storage.local.get(["researchMode"],r=>{r.researchMode})});function h(e){return new Promise((r,o)=>{if(!e){o(new Error("Notebook name is required"));return}chrome.storage.local.get(["notebooks"],t=>{const n=t.notebooks||{};if(n[e]){o(new Error(`Notebook "${e}" already exists`));return}n[e]={},chrome.storage.local.set({notebooks:n,currentNotebook:e},()=>{r({name:e,notebook:n[e]})})})})}function f(e,r){return new Promise((o,t)=>{if(!e){t(new Error("Notebook name is required"));return}if(!r||!r.url){t(new Error("Source URL is required"));return}chrome.storage.local.get(["notebooks"],n=>{const s=n.notebooks||{};if(!s[e]){t(new Error(`Notebook "${e}" does not exist`));return}const c=`source_${Date.now()}`;s[e][c]={url:r.url,title:r.title||r.url,type:r.type||"web",added_datetime:r.datetime||new Date().toISOString()},chrome.storage.local.set({notebooks:s},()=>{o({notebookName:e,sourceId:c,source:s[e][c]})})})})}function m(e,r){return new Promise((o,t)=>{if(!e){t(new Error("Notebook name is required"));return}if(!r){t(new Error("Source ID is required"));return}chrome.storage.local.get(["notebooks"],n=>{const s=n.notebooks||{};if(!s[e]){t(new Error(`Notebook "${e}" does not exist`));return}if(!s[e][r]){t(new Error(`Source "${r}" does not exist in notebook "${e}"`));return}delete s[e][r],chrome.storage.local.set({notebooks:s},()=>{o({notebookName:e,sourceId:r})})})})}function b(e){return new Promise((r,o)=>{chrome.storage.local.get(["notebooks"],t=>{const n=t.notebooks||{};if(e&&!n[e]){o(new Error(`Notebook "${e}" does not exist`));return}chrome.storage.local.set({currentNotebook:e},()=>{r({currentNotebook:e})})})})}function y(e){return new Promise(r=>{chrome.storage.local.set({researchMode:e},()=>{e?chrome.tabs.query({},o=>{for(const t of o)u(t.id)}):chrome.tabs.query({},o=>{for(const t of o)g(t.id)}),r({researchMode:e})})})}chrome.runtime.onMessage.addListener((e,r,o)=>{if(console.log("Message received:",e),e.action==="CREATE_NOTEBOOK")return h(e.name).then(t=>o({status:"success",data:t})).catch(t=>o({status:"error",error:t.message})),!0;if(e.action==="ADD_SOURCE")return chrome.storage.local.get(["currentNotebook"],t=>{if(!t.currentNotebook){o({status:"error",error:"No notebook selected"});return}f(t.currentNotebook,{url:e.url,title:e.title,type:e.type,datetime:e.datetime}).then(n=>o({status:"success",data:n})).catch(n=>o({status:"error",error:n.message}))}),!0;if(e.action==="DELETE_SOURCE")return m(e.notebookName,e.sourceId).then(t=>o({status:"success",data:t})).catch(t=>o({status:"error",error:t.message})),!0;if(e.action==="SET_CURRENT_NOTEBOOK")return b(e.name).then(t=>o({status:"success",data:t})).catch(t=>o({status:"error",error:t.message})),!0;if(e.action==="TOGGLE_RESEARCH_MODE")return y(e.enabled).then(t=>o({status:"success",data:t})).catch(t=>o({status:"error",error:t.message})),!0});
