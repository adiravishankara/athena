console.log("Background script loaded");function b(e){chrome.tabs.get(e,r=>{const o=r.url;if(!o||o.startsWith("chrome://")||o.startsWith("chrome-extension://")||o.startsWith("edge://")||o.startsWith("about:")){console.log("Cannot inject script into",o);return}chrome.storage.local.get(["currentNotebook","notebooks"],t=>{const n=t.currentNotebook,a=t.notebooks||{};let i=!1,c=!1;n&&a[n]&&a[n].sources&&Object.values(a[n].sources).forEach(u=>{const l=h(o),d=h(u.url);l===d&&(i=!0)}),c=o.toLowerCase().includes("youtube.com")||o.toLowerCase().includes("youtu.be"),chrome.scripting.executeScript({target:{tabId:e},function:u=>{const{isAlreadySaved:l,isYouTube:d}=u;if(document.getElementById("athena-floating-button")){const g=document.getElementById("athena-floating-button");g.innerHTML=l?"✓":"+",g.style.background=l?"#2e7d32":"#004d40";return}const s=document.createElement("div");s.id="athena-floating-button",s.innerHTML=l?"✓":"+",s.style.position="fixed",s.style.bottom="50%",s.style.right="20px",s.style.transform="translateY(50%)",s.style.background=l?"#2e7d32":"#004d40",s.style.color="white",s.style.width="40px",s.style.height="40px",s.style.padding="0",s.style.borderRadius="50%",s.style.fontSize="24px",s.style.fontWeight="bold",s.style.cursor="pointer",s.style.zIndex="2147483647",s.style.boxShadow="0 4px 8px rgba(0,0,0,0.4)",s.style.display="flex",s.style.justifyContent="center",s.style.alignItems="center",s.style.lineHeight="40px",s.style.textAlign="center",s.style.fontFamily="Arial, sans-serif",s.style.border="none",s.style.margin="0",s.style.userSelect="none",d&&(s.title="Add YouTube video to notebook",s.style.transition="transform 0.2s ease-in-out",s.addEventListener("mouseover",()=>{s.style.transform="translateY(50%) scale(1.1)"}),s.addEventListener("mouseout",()=>{s.style.transform="translateY(50%) scale(1)"})),document.body.appendChild(s)},args:[{isAlreadySaved:i,isYouTube:c}]}).catch(u=>{console.error("Script injection error:",u)})})})}function h(e){try{const r=new URL(e);if(r.hostname.includes("youtube.com")){const o=r.searchParams.get("v");if(o)return`youtube.com/watch?v=${o}`}else if(r.hostname.includes("youtu.be")){const o=r.pathname.substring(1);if(o)return`youtube.com/watch?v=${o}`}return e.toLowerCase()}catch(r){return console.error("Error normalizing URL:",r),e.toLowerCase()}}function f(e){chrome.scripting.executeScript({target:{tabId:e},function:()=>{const r=document.getElementById("athena-floating-button");r&&r.remove()}}).catch(r=>{console.log("Cannot remove button from this page")})}chrome.runtime.onInstalled.addListener(()=>{console.log("Athena Extension Installed"),chrome.storage.local.get(["notebooks","currentNotebook","researchMode"],e=>{e.notebooks||chrome.storage.local.set({notebooks:{}}),e.currentNotebook||chrome.storage.local.set({currentNotebook:null}),e.researchMode===void 0&&chrome.storage.local.set({researchMode:!1})})});chrome.tabs.onUpdated.addListener((e,r,o)=>{r.status==="complete"&&chrome.storage.local.get(["researchMode"],t=>{(t.researchMode||!1)&&b(e)})});chrome.tabs.onCreated.addListener(e=>{chrome.storage.local.get(["researchMode"],r=>{r.researchMode})});function m(e){return new Promise((r,o)=>{if(!e){o(new Error("Notebook name is required"));return}chrome.storage.local.get(["notebooks"],t=>{const n=t.notebooks||{};if(n[e]){o(new Error(`Notebook "${e}" already exists`));return}n[e]={created_datetime:new Date().toISOString(),last_updated_datetime:new Date().toISOString(),last_sync_datetime:null,notebookLM_id:null,notebookLM_url:null,notebookLM_title:null,sources:{}},chrome.storage.local.set({notebooks:n,currentNotebook:e},()=>{r({name:e,notebook:n[e]})})})})}function y(e,r){return new Promise((o,t)=>{if(!e){t(new Error("Notebook name is required"));return}if(!r||!r.url){t(new Error("Source URL is required"));return}chrome.storage.local.get(["notebooks"],n=>{const a=n.notebooks||{};if(!a[e]){t(new Error(`Notebook "${e}" does not exist`));return}const i=`source_${Date.now()}`;a[e].sources||(a[e].sources={}),a[e].sources[i]={url:r.url,title:r.title||r.url,linkType:r.type||"web",added_datetime:r.datetime||new Date().toISOString(),added_to_notebook:!1},a[e].last_updated_datetime=new Date().toISOString(),chrome.storage.local.set({notebooks:a},()=>{o({notebookName:e,sourceId:i,source:a[e].sources[i]})})})})}function k(e,r){return new Promise((o,t)=>{if(!e){t(new Error("Notebook name is required"));return}if(!r){t(new Error("Source ID is required"));return}chrome.storage.local.get(["notebooks"],n=>{const a=n.notebooks||{};if(!a[e]){t(new Error(`Notebook "${e}" does not exist`));return}if(!a[e].sources||!a[e].sources[r]){t(new Error(`Source "${r}" does not exist in notebook "${e}"`));return}delete a[e].sources[r],a[e].last_updated_datetime=new Date().toISOString(),chrome.storage.local.set({notebooks:a},()=>{o({notebookName:e,sourceId:r})})})})}function S(e){return new Promise((r,o)=>{chrome.storage.local.get(["notebooks"],t=>{const n=t.notebooks||{};if(e&&!n[e]){o(new Error(`Notebook "${e}" does not exist`));return}chrome.storage.local.set({currentNotebook:e},()=>{r({currentNotebook:e})})})})}function E(e){return new Promise(r=>{chrome.storage.local.set({researchMode:e},()=>{e?chrome.tabs.query({},o=>{for(const t of o)b(t.id)}):chrome.tabs.query({},o=>{for(const t of o)f(t.id)}),r({researchMode:e})})})}function w(e,r,o){const{notebookName:t,sourceId:n,added_to_notebook:a}=e;return chrome.storage.local.get(["notebooks"],i=>{const c=i.notebooks||{};if(!c[t]||!c[t].sources||!c[t].sources[n]){o({status:"error",error:"Source not found"});return}c[t].sources[n].added_to_notebook=a,a&&(c[t].last_sync_datetime=new Date().toISOString()),chrome.storage.local.set({notebooks:c},()=>{o({status:"success",data:{notebookName:t,sourceId:n,added_to_notebook:a}})})}),!0}chrome.runtime.onMessage.addListener((e,r,o)=>{if(console.log("Message received:",e),e.action==="CREATE_NOTEBOOK")return m(e.name).then(t=>o({status:"success",data:t})).catch(t=>o({status:"error",error:t.message})),!0;if(e.action==="ADD_SOURCE")return chrome.storage.local.get(["currentNotebook"],t=>{if(!t.currentNotebook){o({status:"error",error:"No notebook selected"});return}y(t.currentNotebook,{url:e.url,title:e.title,type:e.type,datetime:e.datetime}).then(n=>{console.log("Source added:",n),o({status:"success",data:n})}).catch(n=>{console.error("Error adding source:",n),o({status:"error",error:n.message})})}),!0;if(e.action==="DELETE_SOURCE")return k(e.notebookName,e.sourceId).then(t=>o({status:"success",data:t})).catch(t=>o({status:"error",error:t.message})),!0;if(e.action==="SET_CURRENT_NOTEBOOK")return S(e.name).then(t=>o({status:"success",data:t})).catch(t=>o({status:"error",error:t.message})),!0;if(e.action==="TOGGLE_RESEARCH_MODE")return E(e.enabled).then(t=>o({status:"success",data:t})).catch(t=>o({status:"error",error:t.message})),!0;if(e.action==="UPDATE_SOURCE_SYNC_STATUS")return w(e,r,o),!0});
