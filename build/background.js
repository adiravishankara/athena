console.log("Background script loaded");function p(t){chrome.tabs.get(t,n=>{const r=n.url;if(!r||r.startsWith("chrome://")||r.startsWith("chrome-extension://")||r.startsWith("edge://")||r.startsWith("about:")){console.log("Cannot inject script into",r);return}chrome.storage.local.get(["currentNotebook","notebooks"],e=>{const i=e.currentNotebook,c=e.notebooks||{};let u=!1;i&&c[i]&&Object.values(c[i]).forEach(s=>{s.url===r&&(u=!0)}),chrome.scripting.executeScript({target:{tabId:t},function:s=>{if(document.getElementById("athena-floating-button"))return;const o=document.createElement("div");o.id="athena-floating-button",o.innerHTML=s?"✓":"+",o.style.position="fixed !important",o.style.bottom="50% !important",o.style.right="20px !important",o.style.transform="translateY(50%) !important",o.style.background=s?"#2e7d32 !important":"#004d40 !important",o.style.color="white !important",o.style.width="40px !important",o.style.height="40px !important",o.style.padding="0 !important",o.style.borderRadius="50% !important",o.style.fontSize="24px !important",o.style.fontWeight="bold !important",o.style.cursor="pointer !important",o.style.zIndex="2147483647 !important",o.style.boxShadow="0 4px 8px rgba(0,0,0,0.4) !important",o.style.display="flex !important",o.style.justifyContent="center !important",o.style.alignItems="center !important",o.style.lineHeight="40px !important",o.style.textAlign="center !important",o.style.fontFamily="Arial, sans-serif !important",o.style.border="none !important",o.style.margin="0 !important",o.style.userSelect="none !important";let g=!1,f,h;o.addEventListener("mousedown",function(d){g=!0,f=d.clientX-o.getBoundingClientRect().left,h=d.clientY-o.getBoundingClientRect().top}),document.addEventListener("mousemove",function(d){if(g){const m=d.clientX-f,b=d.clientY-h;o.style.right="auto",o.style.bottom="auto",o.style.left=m+"px",o.style.top=b+"px"}}),document.addEventListener("mouseup",function(){g=!1}),o.addEventListener("click",function(d){if(!g){if(s){const a=document.createElement("div");a.textContent="Already added to notebook",a.style.position="fixed",a.style.bottom="100px",a.style.right="20px",a.style.backgroundColor="rgba(46, 125, 50, 0.9)",a.style.color="white",a.style.padding="10px 15px",a.style.borderRadius="4px",a.style.zIndex="10001",document.body.appendChild(a),setTimeout(()=>{a.remove()},2e3);return}const m=window.location.href,b=document.title;chrome.runtime.sendMessage({action:"ADD_SOURCE",url:m,title:b,type:"web",datetime:new Date().toISOString()},a=>{if(a&&a.status==="success")o.style.background="#2e7d32 !important",o.innerHTML="✓",s=!0;else{const l=document.createElement("div");l.textContent=a&&a.error?a.error:"Failed to add to notebook",l.style.position="fixed",l.style.bottom="100px",l.style.right="20px",l.style.backgroundColor="rgba(211, 47, 47, 0.9)",l.style.color="white",l.style.padding="10px 15px",l.style.borderRadius="4px",l.style.zIndex="10001",document.body.appendChild(l),setTimeout(()=>{l.remove()},2e3)}})}}),document.body.appendChild(o),new MutationObserver(d=>{d.forEach(m=>{m.type==="attributes"&&m.attributeName==="style"?(o.style.width="40px !important",o.style.height="40px !important",o.style.fontSize="24px !important",o.style.background=s?"#2e7d32 !important":"#004d40 !important",o.style.zIndex="2147483647 !important"):m.type==="childList"&&m.target===o&&(o.innerHTML=s?"✓":"+")})}).observe(o,{attributes:!0,attributeFilter:["style"],childList:!0})},args:[u]}).catch(s=>{console.error("Script injection error:",s)})})})}function y(t){chrome.scripting.executeScript({target:{tabId:t},function:()=>{const n=document.getElementById("athena-floating-button");n&&n.remove()}}).catch(n=>{console.log("Cannot remove button from this page")})}chrome.runtime.onInstalled.addListener(()=>{console.log("Athena Extension Installed"),chrome.storage.local.get(["notebooks","currentNotebook","researchMode"],t=>{t.notebooks||chrome.storage.local.set({notebooks:{}}),t.currentNotebook||chrome.storage.local.set({currentNotebook:null}),t.researchMode===void 0&&chrome.storage.local.set({researchMode:!1})})});chrome.tabs.onUpdated.addListener((t,n,r)=>{n.status==="complete"&&chrome.storage.local.get(["researchMode"],e=>{(e.researchMode||!1)&&p(t)})});chrome.tabs.onCreated.addListener(t=>{chrome.storage.local.get(["researchMode"],n=>{n.researchMode})});function k(t){return new Promise((n,r)=>{if(!t){r(new Error("Notebook name is required"));return}chrome.storage.local.get(["notebooks"],e=>{const i=e.notebooks||{};if(i[t]){r(new Error(`Notebook "${t}" already exists`));return}i[t]={},chrome.storage.local.set({notebooks:i,currentNotebook:t},()=>{n({name:t,notebook:i[t]})})})})}function x(t,n){return new Promise((r,e)=>{if(!t){e(new Error("Notebook name is required"));return}if(!n||!n.url){e(new Error("Source URL is required"));return}chrome.storage.local.get(["notebooks"],i=>{const c=i.notebooks||{};if(!c[t]){e(new Error(`Notebook "${t}" does not exist`));return}const u=`source_${Date.now()}`;c[t][u]={url:n.url,title:n.title||n.url,type:n.type||"web",added_datetime:n.datetime||new Date().toISOString()},chrome.storage.local.set({notebooks:c},()=>{r({notebookName:t,sourceId:u,source:c[t][u]})})})})}function E(t,n){return new Promise((r,e)=>{if(!t){e(new Error("Notebook name is required"));return}if(!n){e(new Error("Source ID is required"));return}chrome.storage.local.get(["notebooks"],i=>{const c=i.notebooks||{};if(!c[t]){e(new Error(`Notebook "${t}" does not exist`));return}if(!c[t][n]){e(new Error(`Source "${n}" does not exist in notebook "${t}"`));return}delete c[t][n],chrome.storage.local.set({notebooks:c},()=>{r({notebookName:t,sourceId:n})})})})}function w(t){return new Promise((n,r)=>{chrome.storage.local.get(["notebooks"],e=>{const i=e.notebooks||{};if(t&&!i[t]){r(new Error(`Notebook "${t}" does not exist`));return}chrome.storage.local.set({currentNotebook:t},()=>{n({currentNotebook:t})})})})}function S(t){return new Promise(n=>{chrome.storage.local.set({researchMode:t},()=>{t?chrome.tabs.query({},r=>{for(const e of r)p(e.id)}):chrome.tabs.query({},r=>{for(const e of r)y(e.id)}),n({researchMode:t})})})}function _(t,n,r){const{notebookName:e,sourceId:i,added_to_notebook:c}=t;return chrome.storage.local.get(["notebooks"],u=>{const s=u.notebooks||{};if(!s[e]||!s[e][i]){r({status:"error",error:"Source not found"});return}s[e][i].added_to_notebook=c,c&&(s[e].last_sync_datetime?s[e].last_sync_datetime=new Date().toISOString():Object.defineProperty(s[e],"last_sync_datetime",{value:new Date().toISOString(),writable:!0,enumerable:!0,configurable:!0})),chrome.storage.local.set({notebooks:s},()=>{r({status:"success",data:{notebookName:e,sourceId:i,added_to_notebook:c}})})}),!0}chrome.runtime.onMessage.addListener((t,n,r)=>{if(console.log("Message received:",t),t.action==="CREATE_NOTEBOOK")return k(t.name).then(e=>r({status:"success",data:e})).catch(e=>r({status:"error",error:e.message})),!0;if(t.action==="ADD_SOURCE")return chrome.storage.local.get(["currentNotebook"],e=>{if(!e.currentNotebook){r({status:"error",error:"No notebook selected"});return}x(e.currentNotebook,{url:t.url,title:t.title,type:t.type,datetime:t.datetime}).then(i=>{console.log("Source added:",i),r({status:"success",data:i})}).catch(i=>{console.error("Error adding source:",i),r({status:"error",error:i.message})})}),!0;if(t.action==="DELETE_SOURCE")return E(t.notebookName,t.sourceId).then(e=>r({status:"success",data:e})).catch(e=>r({status:"error",error:e.message})),!0;if(t.action==="SET_CURRENT_NOTEBOOK")return w(t.name).then(e=>r({status:"success",data:e})).catch(e=>r({status:"error",error:e.message})),!0;if(t.action==="TOGGLE_RESEARCH_MODE")return S(t.enabled).then(e=>r({status:"success",data:e})).catch(e=>r({status:"error",error:e.message})),!0;if(t.action==="UPDATE_SOURCE_SYNC_STATUS")return _(t,n,r),!0});
