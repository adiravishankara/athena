console.log("Background script loaded");chrome.runtime.onInstalled.addListener(()=>{console.log("Athena Extension Installed"),chrome.storage.local.get(["notebooks","currentNotebook","researchMode"],t=>{t.notebooks||chrome.storage.local.set({notebooks:{}}),t.currentNotebook||chrome.storage.local.set({currentNotebook:null}),t.researchMode===void 0&&chrome.storage.local.set({researchMode:!1})})});function h(t){return new Promise((n,r)=>{if(!t){r(new Error("Notebook name is required"));return}chrome.storage.local.get(["notebooks"],o=>{const i=o.notebooks||{};if(i[t]){r(new Error(`Notebook "${t}" already exists`));return}i[t]={},chrome.storage.local.set({notebooks:i,currentNotebook:t},()=>{n({name:t,notebook:i[t]})})})})}function f(t,n){return new Promise((r,o)=>{if(!t){o(new Error("Notebook name is required"));return}if(!n||!n.url){o(new Error("Source URL is required"));return}chrome.storage.local.get(["notebooks"],i=>{const e=i.notebooks||{};if(!e[t]){o(new Error(`Notebook "${t}" does not exist`));return}const c=`source_${Date.now()}`;e[t][c]={url:n.url,title:n.title||n.url,type:n.type||"web",added_datetime:n.datetime||new Date().toISOString()},chrome.storage.local.set({notebooks:e},()=>{r({notebookName:t,sourceId:c,source:e[t][c]})})})})}function m(t,n){return new Promise((r,o)=>{if(!t){o(new Error("Notebook name is required"));return}if(!n){o(new Error("Source ID is required"));return}chrome.storage.local.get(["notebooks"],i=>{const e=i.notebooks||{};if(!e[t]){o(new Error(`Notebook "${t}" does not exist`));return}if(!e[t][n]){o(new Error(`Source "${n}" does not exist in notebook "${t}"`));return}delete e[t][n],chrome.storage.local.set({notebooks:e},()=>{r({notebookName:t,sourceId:n})})})})}function b(t){return new Promise((n,r)=>{chrome.storage.local.get(["notebooks"],o=>{const i=o.notebooks||{};if(t&&!i[t]){r(new Error(`Notebook "${t}" does not exist`));return}chrome.storage.local.set({currentNotebook:t},()=>{n({currentNotebook:t})})})})}function y(t){return new Promise(n=>{chrome.storage.local.set({researchMode:t},()=>{chrome.tabs.query({active:!0,currentWindow:!0},r=>{if(r.length===0)return;const o=r[0],i=o.url;if(!i||i.startsWith("chrome://")||i.startsWith("chrome-extension://")||i.startsWith("edge://")||i.startsWith("about:")){console.log("Cannot inject script into",i),n({researchMode:t});return}t?chrome.scripting.executeScript({target:{tabId:o.id},function:()=>{if(document.getElementById("athena-floating-button"))return;const e=document.createElement("div");e.id="athena-floating-button",e.innerHTML="+",e.style.position="fixed",e.style.bottom="20px",e.style.right="20px",e.style.background="#004d40",e.style.color="white",e.style.padding="15px 18px",e.style.borderRadius="50%",e.style.fontSize="24px",e.style.fontWeight="bold",e.style.cursor="pointer",e.style.zIndex="10000",e.style.boxShadow="0 2px 5px rgba(0,0,0,0.3)",e.style.display="flex",e.style.justifyContent="center",e.style.alignItems="center",e.style.width="40px",e.style.height="40px";let c=!1,u,d;e.addEventListener("mousedown",function(s){c=!0,u=s.clientX-e.getBoundingClientRect().left,d=s.clientY-e.getBoundingClientRect().top}),document.addEventListener("mousemove",function(s){if(c){const a=s.clientX-u,l=s.clientY-d;e.style.right="auto",e.style.bottom="auto",e.style.left=a+"px",e.style.top=l+"px"}}),document.addEventListener("mouseup",function(){c=!1}),e.addEventListener("click",function(s){if(!c){const a=window.location.href,l=document.title;chrome.runtime.sendMessage({action:"ADD_SOURCE",url:a,title:l,type:"web",datetime:new Date().toISOString()});const g=e.style.background;e.style.background="#2e7d32",e.innerHTML="âœ“",setTimeout(()=>{e.style.background=g,e.innerHTML="+"},1e3)}}),document.body.appendChild(e)}}).catch(e=>{console.error("Script injection error:",e)}):chrome.scripting.executeScript({target:{tabId:o.id},function:()=>{const e=document.getElementById("athena-floating-button");e&&e.remove()}}).catch(e=>{console.error("Script removal error:",e)})}),n({researchMode:t})})})}chrome.runtime.onMessage.addListener((t,n,r)=>{if(console.log("Message received:",t),t.action==="CREATE_NOTEBOOK")return h(t.name).then(o=>r({status:"success",data:o})).catch(o=>r({status:"error",error:o.message})),!0;if(t.action==="ADD_SOURCE")return chrome.storage.local.get(["currentNotebook"],o=>{if(!o.currentNotebook){r({status:"error",error:"No notebook selected"});return}f(o.currentNotebook,{url:t.url,title:t.title,type:t.type,datetime:t.datetime}).then(i=>r({status:"success",data:i})).catch(i=>r({status:"error",error:i.message}))}),!0;if(t.action==="DELETE_SOURCE")return m(t.notebookName,t.sourceId).then(o=>r({status:"success",data:o})).catch(o=>r({status:"error",error:o.message})),!0;if(t.action==="SET_CURRENT_NOTEBOOK")return b(t.name).then(o=>r({status:"success",data:o})).catch(o=>r({status:"error",error:o.message})),!0;if(t.action==="TOGGLE_RESEARCH_MODE")return y(t.enabled).then(o=>r({status:"success",data:o})).catch(o=>r({status:"error",error:o.message})),!0});
