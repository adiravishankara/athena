console.log("Background script loaded");function y(t){chrome.tabs.get(t,n=>{const o=n.url;if(!o||o.startsWith("chrome://")||o.startsWith("chrome-extension://")||o.startsWith("edge://")||o.startsWith("about:")){console.log("Cannot inject script into",o);return}chrome.storage.local.get(["currentNotebook","notebooks"],e=>{const s=e.currentNotebook,i=e.notebooks||{};let d=!1;s&&i[s]&&Object.values(i[s]).forEach(l=>{l.url===o&&(d=!0)}),chrome.scripting.executeScript({target:{tabId:t},function:l=>{if(document.getElementById("athena-floating-button"))return;const r=document.createElement("div");r.id="athena-floating-button",r.innerHTML=l?"âœ“":"+",r.style.position="fixed",r.style.bottom="50%",r.style.right="20px",r.style.transform="translateY(50%)",r.style.background=l?"#2e7d32":"#004d40",r.style.color="white",r.style.padding="18px 22px",r.style.borderRadius="50%",r.style.fontSize="28px",r.style.fontWeight="bold",r.style.cursor="pointer",r.style.zIndex="10000",r.style.boxShadow="0 4px 8px rgba(0,0,0,0.4)",r.style.display="flex",r.style.justifyContent="center",r.style.alignItems="center",r.style.width="50px",r.style.height="50px";let g=!1,b,m;r.addEventListener("mousedown",function(u){g=!0,b=u.clientX-r.getBoundingClientRect().left,m=u.clientY-r.getBoundingClientRect().top}),document.addEventListener("mousemove",function(u){if(g){const h=u.clientX-b,f=u.clientY-m;r.style.right="auto",r.style.bottom="auto",r.style.left=h+"px",r.style.top=f+"px"}}),document.addEventListener("mouseup",function(){g=!1}),r.addEventListener("click",function(u){if(!g){if(l){const c=document.createElement("div");c.textContent="Already added to notebook",c.style.position="fixed",c.style.bottom="100px",c.style.right="20px",c.style.backgroundColor="rgba(46, 125, 50, 0.9)",c.style.color="white",c.style.padding="10px 15px",c.style.borderRadius="4px",c.style.zIndex="10001",document.body.appendChild(c),setTimeout(()=>{c.remove()},2e3);return}const h=window.location.href,f=document.title;chrome.runtime.sendMessage({action:"ADD_SOURCE",url:h,title:f,type:"web",datetime:new Date().toISOString()},c=>{if(c&&c.status==="success")r.style.background="#2e7d32",r.innerHTML="âœ“",l=!0;else{const a=document.createElement("div");a.textContent=c&&c.error?c.error:"Failed to add to notebook",a.style.position="fixed",a.style.bottom="100px",a.style.right="20px",a.style.backgroundColor="rgba(211, 47, 47, 0.9)",a.style.color="white",a.style.padding="10px 15px",a.style.borderRadius="4px",a.style.zIndex="10001",document.body.appendChild(a),setTimeout(()=>{a.remove()},2e3)}})}}),document.body.appendChild(r)},args:[d]}).catch(l=>{console.error("Script injection error:",l)})})})}function p(t){chrome.scripting.executeScript({target:{tabId:t},function:()=>{const n=document.getElementById("athena-floating-button");n&&n.remove()}}).catch(n=>{console.log("Cannot remove button from this page")})}chrome.runtime.onInstalled.addListener(()=>{console.log("Athena Extension Installed"),chrome.storage.local.get(["notebooks","currentNotebook","researchMode"],t=>{t.notebooks||chrome.storage.local.set({notebooks:{}}),t.currentNotebook||chrome.storage.local.set({currentNotebook:null}),t.researchMode===void 0&&chrome.storage.local.set({researchMode:!1})})});chrome.tabs.onUpdated.addListener((t,n,o)=>{n.status==="complete"&&chrome.storage.local.get(["researchMode"],e=>{(e.researchMode||!1)&&y(t)})});chrome.tabs.onCreated.addListener(t=>{chrome.storage.local.get(["researchMode"],n=>{n.researchMode})});function x(t){return new Promise((n,o)=>{if(!t){o(new Error("Notebook name is required"));return}chrome.storage.local.get(["notebooks"],e=>{const s=e.notebooks||{};if(s[t]){o(new Error(`Notebook "${t}" already exists`));return}s[t]={},chrome.storage.local.set({notebooks:s,currentNotebook:t},()=>{n({name:t,notebook:s[t]})})})})}function k(t,n){return new Promise((o,e)=>{if(!t){e(new Error("Notebook name is required"));return}if(!n||!n.url){e(new Error("Source URL is required"));return}chrome.storage.local.get(["notebooks"],s=>{const i=s.notebooks||{};if(!i[t]){e(new Error(`Notebook "${t}" does not exist`));return}const d=`source_${Date.now()}`;i[t][d]={url:n.url,title:n.title||n.url,type:n.type||"web",added_datetime:n.datetime||new Date().toISOString()},chrome.storage.local.set({notebooks:i},()=>{o({notebookName:t,sourceId:d,source:i[t][d]})})})})}function E(t,n){return new Promise((o,e)=>{if(!t){e(new Error("Notebook name is required"));return}if(!n){e(new Error("Source ID is required"));return}chrome.storage.local.get(["notebooks"],s=>{const i=s.notebooks||{};if(!i[t]){e(new Error(`Notebook "${t}" does not exist`));return}if(!i[t][n]){e(new Error(`Source "${n}" does not exist in notebook "${t}"`));return}delete i[t][n],chrome.storage.local.set({notebooks:i},()=>{o({notebookName:t,sourceId:n})})})})}function w(t){return new Promise((n,o)=>{chrome.storage.local.get(["notebooks"],e=>{const s=e.notebooks||{};if(t&&!s[t]){o(new Error(`Notebook "${t}" does not exist`));return}chrome.storage.local.set({currentNotebook:t},()=>{n({currentNotebook:t})})})})}function C(t){return new Promise(n=>{chrome.storage.local.set({researchMode:t},()=>{t?chrome.tabs.query({},o=>{for(const e of o)y(e.id)}):chrome.tabs.query({},o=>{for(const e of o)p(e.id)}),n({researchMode:t})})})}chrome.runtime.onMessage.addListener((t,n,o)=>{if(console.log("Message received:",t),t.action==="CREATE_NOTEBOOK")return x(t.name).then(e=>o({status:"success",data:e})).catch(e=>o({status:"error",error:e.message})),!0;if(t.action==="ADD_SOURCE")return chrome.storage.local.get(["currentNotebook"],e=>{if(!e.currentNotebook){o({status:"error",error:"No notebook selected"});return}k(e.currentNotebook,{url:t.url,title:t.title,type:t.type,datetime:t.datetime}).then(s=>{console.log("Source added:",s),o({status:"success",data:s})}).catch(s=>{console.error("Error adding source:",s),o({status:"error",error:s.message})})}),!0;if(t.action==="DELETE_SOURCE")return E(t.notebookName,t.sourceId).then(e=>o({status:"success",data:e})).catch(e=>o({status:"error",error:e.message})),!0;if(t.action==="SET_CURRENT_NOTEBOOK")return w(t.name).then(e=>o({status:"success",data:e})).catch(e=>o({status:"error",error:e.message})),!0;if(t.action==="TOGGLE_RESEARCH_MODE")return C(t.enabled).then(e=>o({status:"success",data:e})).catch(e=>o({status:"error",error:e.message})),!0});
