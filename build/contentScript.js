console.log("Content script loaded");chrome.storage.local.get(["researchMode"],function(e){(e.researchMode||!1)&&u()});chrome.storage.onChanged.addListener(function(e,t){t==="local"&&e.researchMode&&(e.researchMode.newValue?u():f())});function u(){if(document.getElementById("athena-floating-button"))return;const e=document.createElement("div");e.id="athena-floating-button",e.innerHTML="+",e.style.position="fixed",e.style.bottom="50%",e.style.right="20px",e.style.transform="translateY(50%)",e.style.background="#004d40",e.style.color="white",e.style.width="40px",e.style.height="40px",e.style.padding="0",e.style.borderRadius="50%",e.style.fontSize="24px",e.style.fontWeight="bold",e.style.cursor="pointer",e.style.zIndex="2147483647",e.style.boxShadow="0 4px 8px rgba(0,0,0,0.4)",e.style.display="flex",e.style.justifyContent="center",e.style.alignItems="center",e.style.lineHeight="40px",e.style.textAlign="center",e.style.fontFamily="Arial, sans-serif",e.style.border="none",e.style.margin="0",e.style.userSelect="none";let t=!1,o,c;e.addEventListener("mousedown",function(s){t=!1,o=s.clientX-e.getBoundingClientRect().left,c=s.clientY-e.getBoundingClientRect().top}),document.addEventListener("mousemove",function(s){if(t){const i=s.clientX-o,a=s.clientY-c;e.style.right="auto",e.style.bottom="auto",e.style.left=i+"px",e.style.top=a+"px"}}),document.addEventListener("mouseup",function(){t=!1}),e.addEventListener("click",async function(s){if(s.preventDefault(),s.stopPropagation(),!t){const i=window.location.href,a=document.title;let r="web";const l=i.toLowerCase();if(l.includes("youtube.com")||l.includes("youtu.be")){if(r="youtube",!g(i)){d("Invalid YouTube URL",!0);return}}else l.includes("docs.google.com/document")?r="googledocs":l.includes("docs.google.com/presentation")||l.includes("slides.google.com")?r="googleslides":l.endsWith(".pdf")&&(r="pdf");try{chrome.runtime.sendMessage({action:"ADD_SOURCE",url:i,title:a,type:r,datetime:new Date().toISOString()},n=>{if(chrome.runtime.lastError){console.error("Error sending message:",chrome.runtime.lastError),d("Failed to add to notebook: Connection error",!0);return}n&&n.status==="success"?(e.style.background="#2e7d32",e.innerHTML="âœ“",d(`Added ${r==="youtube"?"YouTube video":"page"} to notebook`,!1)):d(n&&n.error?n.error:"Failed to add to notebook",!0)})}catch(n){console.error("Error sending message:",n),d("Failed to add to notebook: "+n.message,!0)}}}),document.body.appendChild(e)}function g(e){try{const t=new URL(e);if(t.hostname.includes("youtube.com"))return t.searchParams.get("v");if(t.hostname.includes("youtu.be"))return t.pathname.substring(1)}catch(t){console.error("Error parsing YouTube URL:",t)}return null}function f(){const e=document.getElementById("athena-floating-button");e&&e.remove()}function d(e,t=!1){const o=document.createElement("div");o.textContent=e,o.style.position="fixed",o.style.bottom="100px",o.style.right="20px",o.style.backgroundColor=t?"rgba(211, 47, 47, 0.9)":"rgba(46, 125, 50, 0.9)",o.style.color="white",o.style.padding="10px 15px",o.style.borderRadius="4px",o.style.zIndex="2147483647",document.body.appendChild(o),setTimeout(()=>{o.remove()},2e3)}
